{"version":3,"sources":["../src/parseRole.js"],"names":["_module","_","require","ROLE_KEY","parse","metadata","userRoles","key","isArray","parseArray","parseObject","applyRule","property","hasOwnProperty","map","obj","index","filter","value","length","ruleFunctions","insert","data","merge","ruleObj","intersection","applyForRoles","type","module","exports"],"mappings":"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","file":"parseRole.js","sourcesContent":["var _module,\r\n    _ = require('lodash');\r\nvar ROLE_KEY = 'roleid';\r\n\r\nfunction parse(metadata, userRoles, key = ROLE_KEY) {\r\n    if (_.isArray(metadata)) {\r\n        return parseArray(metadata, userRoles, key);\r\n    } else {\r\n        return parseObject(metadata, userRoles, key);\r\n    }\r\n}\r\n\r\nfunction parseObject(metadata, userRoles, key) {\r\n\r\n    if (metadata[key]) {\r\n        if (!applyRule(userRoles, metadata[key], metadata)) {\r\n            return null;\r\n        }\r\n\r\n        delete metadata[key];\r\n    }\r\n\r\n    for (var property in metadata) {\r\n        if (metadata.hasOwnProperty(property)) {\r\n            if (metadata[property] === null) {\r\n               continue;\r\n            }\r\n            if (_.isArray(metadata[property])) {\r\n                metadata[property] = parseArray(metadata[property], userRoles, key);\r\n            }\r\n            else if ((typeof metadata[property] === \"object\") && (metadata[property] !== null)) {\r\n                metadata[property] = parseObject(metadata[property], userRoles, key);\r\n            }\r\n\r\n            if (metadata[property] === null) {\r\n                delete metadata[property];\r\n            }\r\n        }\r\n    }\r\n\r\n    return metadata;\r\n}\r\n\r\nfunction parseArray(metadata, userRoles, key) {\r\n    metadata = _(metadata).map(function (obj, index) {\r\n        if (_.isArray(obj)) {\r\n            return parseArray(obj, userRoles, key);\r\n        }\r\n        else if ((typeof obj === \"object\") && (obj !== null)) {\r\n            return parseObject(obj, userRoles, key);\r\n        } else {\r\n            return obj;\r\n        }\r\n    }).filter(function (obj) {\r\n        return obj !== null;\r\n    }).value();\r\n    return metadata.length === 0 ? null : metadata;\r\n}\r\n\r\nvar ruleFunctions = {\r\n    insert: function (obj, data) {\r\n        _.merge(obj, data);\r\n    }\r\n};\r\n\r\nfunction applyRule(userRoles, ruleObj, obj) {\r\n    if (_.isArray(ruleObj)) {\r\n        return _.intersection(userRoles, ruleObj).length !== 0;\r\n    }\r\n    if (_.intersection(ruleObj.applyForRoles, userRoles).length !== 0) {\r\n        ruleFunctions[ruleObj.type](obj, ruleObj.data);\r\n    }\r\n    return true;\r\n}\r\n\r\nmodule.exports = _module = {\r\n    parse: parse\r\n};\r\n"]}