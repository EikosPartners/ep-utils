{"version":3,"sources":["../src/parseRole.js"],"names":["_module","_","require","ROLE_KEY","parse","metadata","userRoles","isArray","parseArray","parseObject","applyRule","property","hasOwnProperty","map","obj","index","filter","value","length","ruleFunctions","insert","data","merge","ruleObj","intersection","applyForRoles","type","module","exports"],"mappings":"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","file":"parseRole.js","sourcesContent":["var _module,\n    _ = require('lodash');\nvar ROLE_KEY = 'roleid';\n\nfunction parse(metadata, userRoles) {\n    if (_.isArray(metadata)) {\n        return parseArray(metadata,userRoles);\n    } else {\n        return parseObject(metadata,userRoles);\n    }\n}\n\nfunction parseObject(metadata, userRoles) {\n    if (metadata[ROLE_KEY]) {\n        if (!applyRule(userRoles, metadata[ROLE_KEY], metadata)) {\n            return null;\n        }\n\n        delete metadata[ROLE_KEY];\n    }\n\n    for (var property in metadata) {\n        if (metadata.hasOwnProperty(property)) {\n            if (_.isArray(metadata[property])) {\n                metadata[property] = parseArray(metadata[property], userRoles);\n            }\n            else if( (typeof metadata[property] === \"object\") && (metadata[property] !== null) ) {\n                metadata[property] = parseObject(metadata[property], userRoles);\n            }\n\n            if (metadata[property] === null) {\n                delete metadata[property];\n            }\n        }\n    }\n\n    return metadata;\n}\n\nfunction parseArray(metadata, userRoles) {\n    metadata = _(metadata).map(function (obj, index) {\n        if (_.isArray(obj)) {\n            return parseArray(obj, userRoles);\n        }\n        else if( (typeof obj === \"object\") && (obj !== null) ) {\n            return parseObject(obj, userRoles);\n        } else {\n            return obj;\n        }\n    }).filter(function (obj) {\n        return obj !== null;\n    }).value();\n    return metadata.length === 0 ? null : metadata;\n}\n\nvar ruleFunctions = {\n    insert: function(obj, data) {\n        _.merge(obj, data);\n    }\n};\n\nfunction applyRule(userRoles, ruleObj, obj) {\n    if (_.isArray(ruleObj)) {\n        return _.intersection(userRoles, ruleObj).length !== 0;\n    }    \n    if (_.intersection(ruleObj.applyForRoles, userRoles).length !== 0) {\n        ruleFunctions[ruleObj.type](obj, ruleObj.data);\n    }\n    return true;\n}\n\nmodule.exports = _module = {\n    parse: parse\n};\n"]}