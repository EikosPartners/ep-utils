{"version":3,"sources":["../src/parseRole.js"],"names":["_module","_","require","ROLE_KEY","parse","metadata","userRoles","key","isArray","parseArray","parseObject","console","log","applyRule","property","hasOwnProperty","map","obj","index","filter","value","length","ruleFunctions","insert","data","merge","ruleObj","intersection","applyForRoles","type","module","exports"],"mappings":"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","file":"parseRole.js","sourcesContent":["var _module,\r\n    _ = require('lodash');\r\nvar ROLE_KEY = 'roleid';\r\n\r\nfunction parse(metadata, userRoles, key = ROLE_KEY) {\r\n    if (_.isArray(metadata)) {\r\n        return parseArray(metadata,userRoles,key);\r\n    } else {\r\n        return parseObject(metadata,userRoles, key);\r\n    }\r\n}\r\n\r\nfunction parseObject(metadata, userRoles, key) {\r\n    \r\n    console.log(metadata);\r\n    \r\n    if (metadata[key]) {\r\n        if (!applyRule(userRoles, metadata[key], metadata)) {\r\n            return null;\r\n        }\r\n\r\n        delete metadata[key];\r\n    }\r\n\r\n    for (var property in metadata) {\r\n        if (metadata.hasOwnProperty(property)) {\r\n            if (_.isArray(metadata[property])) {\r\n                metadata[property] = parseArray(metadata[property], userRoles, key);\r\n            }\r\n            else if( (typeof metadata[property] === \"object\") && (metadata[property] !== null) ) {\r\n                metadata[property] = parseObject(metadata[property], userRoles, key);\r\n            }\r\n\r\n            if (metadata[property] === null) {\r\n                delete metadata[property];\r\n            }\r\n        }\r\n    }\r\n\r\n    return metadata;\r\n}\r\n\r\nfunction parseArray(metadata, userRoles,key) {\r\n    metadata = _(metadata).map(function (obj, index) {\r\n        if (_.isArray(obj)) {\r\n            return parseArray(obj, userRoles, key);\r\n        }\r\n        else if( (typeof obj === \"object\") && (obj !== null) ) {\r\n            return parseObject(obj, userRoles, key);\r\n        } else {\r\n            return obj;\r\n        }\r\n    }).filter(function (obj) {\r\n        return obj !== null;\r\n    }).value();\r\n    return metadata.length === 0 ? null : metadata;\r\n}\r\n\r\nvar ruleFunctions = {\r\n    insert: function(obj, data) {\r\n        _.merge(obj, data);\r\n    }\r\n};\r\n\r\nfunction applyRule(userRoles, ruleObj, obj) {\r\n    if (_.isArray(ruleObj)) {\r\n        return _.intersection(userRoles, ruleObj).length !== 0;\r\n    }    \r\n    if (_.intersection(ruleObj.applyForRoles, userRoles).length !== 0) {\r\n        ruleFunctions[ruleObj.type](obj, ruleObj.data);\r\n    }\r\n    return true;\r\n}\r\n\r\nmodule.exports = _module = {\r\n    parse: parse\r\n};\r\n"]}