{"version":3,"sources":["../src/sortAndFilter.js"],"names":["_module","utils","require","_","compare","l","r","Number","Date","indexOf","Array","isArray","some","i","String","toUpperCase","module","exports","get_type","fields","field","length","id","type","sort","data","sort_column","sort_order","asc","a","b","result","undefined","first","parse","second","toString","localeCompare","filter","search","value","replace","split","op","item","Object","keys","reduce","prev","filtered","filter_switch","filter_columns","filters","filterId","map","f","filterObj","index","options","callback","start","orderby","DEBUG","console","log","JSON","stringify","key","dir","count","isNaN","resultsKey","results","slice","final","total"],"mappings":"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","file":"sortAndFilter.js","sourcesContent":["var _module,\r\n    utils = require('./dataUtils'),\r\n    _ = require('lodash');\r\n\r\nvar compare = {\r\n    '=': function (l, r) {\r\n        return l == r; //use unstrict comparisions so strings can be compared with numbers\r\n    },\r\n    '!=': function (l, r) {\r\n        return l != r;\r\n    },\r\n    '<': function (l, r) {\r\n        return Number(l) < Number(r);\r\n    },\r\n    '>': function (l, r) {\r\n        return Number(l) > Number(r);\r\n    },\r\n    '<=': function (l, r) {\r\n        return Number(l) <= Number(r);\r\n    },\r\n    '>=': function (l, r) {\r\n        return Number(l) >= Number(r);\r\n    },\r\n    'minDate': function (l, r) {\r\n        return new Date(l) >= new Date(r);\r\n    },\r\n    'maxDate': function (l, r) {\r\n        return new Date(l) <= new Date(r);\r\n    },\r\n    'in': function(l, r) {\r\n      return r.indexOf(l) >-1 ;\r\n    },\r\n    'contains': function (l, r) {\r\n        //console.log(\"contains\", arguments);\r\n        return Array.isArray(l) || typeof l === \"string\" ? l.indexOf(r) !== -1 : false;\r\n    },\r\n    'notcontains': function (l, r) {\r\n        //console.log(\"notcontains\", arguments);\r\n        return Array.isArray(l) || typeof l === \"string\" ? l.indexOf(r) === -1 : false;\r\n    },\r\n    'containsatleastone': function (l, r) {\r\n        //console.log(\"containsatleastone\", arguments);\r\n        if (!Array.isArray(l) || !Array.isArray(r)) return false;\r\n        return r.some(function (i) {\r\n            return l.indexOf(i) !== -1;\r\n        });\r\n    },\r\n    \"startsWithCI\": function(l, r) {\r\n        return String(l).toUpperCase().indexOf(String(r).toUpperCase()) === 0;\r\n    },\r\n    '': function () {\r\n        return true;\r\n    }\r\n};\r\n\r\nmodule.exports = _module = {\r\n    get_type: function (fields, field) {\r\n        for (var i = 0; i < fields.length; i++) {\r\n            if (fields[i].id === field) {\r\n                return fields[i].type;\r\n            }\r\n        }\r\n    },\r\n    sort: function (data, type, sort_column, sort_order) {\r\n        var asc;\r\n        if (sort_column != null) {\r\n            asc = (sort_order == null || sort_order === true || sort_order.toUpperCase() !== 'DESC') ? 1 : -1;\r\n            data = data.sort(function (a, b) {\r\n                var result;\r\n                if (a[sort_column] === undefined) {\r\n                    result = 0;\r\n                }\r\n                else {\r\n                    switch (type) {\r\n                        case \"number\":\r\n                            result = Number(a[sort_column]) - Number(b[sort_column]);\r\n                            break;\r\n                        case \"datetime\":\r\n                            var first = Date.parse(a[sort_column]),\r\n                                second = Date.parse(b[sort_column]);\r\n                            result = first === second ? 0 : first - second > 0 ? 1 : -1;\r\n                            break;\r\n                        case \"checkbox\":\r\n                            result = (a[sort_column] === b[sort_column])? 0 : a[sort_column]? -1 : 1;\r\n                            break;\r\n                        default:\r\n                            result = a[sort_column].toString()\r\n                                .localeCompare(b[sort_column].toString());\r\n                            break;\r\n                    }\r\n                }\r\n                return asc * result;\r\n            });\r\n        }\r\n        return data;\r\n    },\r\n    // search box\r\n    filter: function (data, search) {\r\n\r\n        if (search !== undefined && search.indexOf(',') > -1) {\r\n            search = {\r\n                value : search.toUpperCase().replace(/ /g, '').split(','),\r\n                'op' : 'in'\r\n            };\r\n        } else {\r\n            search = {\r\n                value: search,\r\n                op: \"startsWithCI\"\r\n            };\r\n        }\r\n        if (search != null && String(search) != \"\") {\r\n            return data.filter(function (item) {\r\n                return Object.keys(item).reduce(function (prev, field) {\r\n                    var filtered = _module.filter_switch(item, field, search)\r\n                    return prev || filtered;\r\n                }, false);\r\n            });\r\n        }\r\n        return data;\r\n    },\r\n    // filter for columns\r\n    filter_columns: function (data, filters) {\r\n        if (filters != null) {\r\n            return data.filter(function (item) {\r\n                return Object.keys(filters).reduce(function (prev, filter) {\r\n                    return prev\r\n                        && _module.filter_switch(item, filter, filters[filter]);\r\n                }, true);\r\n            });\r\n        }\r\n        return data;\r\n    },\r\n    filter_switch: function (item, filterId, filter) {\r\n            // change simple filter to complex filter if needed\r\n            if(Array.isArray(filter) || typeof filter !== \"object\") {\r\n                if(Array.isArray(filter)) {\r\n                    filter = filter.map(function(f) {\r\n                        if(typeof f !== \"object\") {\r\n                            return {\r\n                                value: f\r\n                            };\r\n                        }\r\n                        return f;\r\n                    });\r\n                } else {\r\n                    filter = {\r\n                        \"value\": filter\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (compare[filter.op]) {\r\n                return compare[filter.op](item[filterId], filter.value);\r\n            }\r\n            // operator not defined. perform default compare\r\n            if (filter instanceof Array) {\r\n\r\n                // see if value exists in array\r\n                return filter.reduce(function (prev, filterObj, index) {\r\n                    // if filter contains a comparison operator, initial value\r\n                    // should be true, as the return will be 'and'ing the values\r\n                    if (filterObj.op && compare[filterObj.op]) {\r\n                        prev = index === 0 ? true : prev;\r\n                        return prev && compare[filterObj.op](item[filterId], filterObj.value)\r\n                    }\r\n                    var result =  prev || filterObj.value.indexOf(item[filterId]) === 0 ;\r\n                    return result;\r\n                }, false);\r\n            }\r\n\r\n            return String(item[filterId]).indexOf(filter.value) === 0;\r\n\r\n    },\r\n    search: function (data, options, callback) {\r\n\r\n        var start = Number(options.start) || 0,\r\n            search = options.search,\r\n            filters = options.filters,\r\n            orderby = options.orderby;\r\n\r\n        if (utils.DEBUG) console.log('search options', JSON.stringify(options));\r\n\r\n        for (var key in orderby) {\r\n            _module.sort(data, orderby[key].type, key, orderby[key].dir);\r\n        }\r\n\r\n        if (search) {\r\n            data = _module.filter(data, search);\r\n        }\r\n        if (filters) {\r\n            data = _module.filter_columns(data, filters);\r\n        }\r\n\r\n        var count = Number(options.count);\r\n        if (count === undefined || count < 0 || isNaN(count)) {\r\n            count = data.length;\r\n        }\r\n        // if no resultskey is given use SearchResult\r\n        var resultsKey = \"SearchResult\";\r\n        if(options.resultsKey){\r\n            resultsKey = options.resultsKey;\r\n        }\r\n        var results = {};\r\n        results[resultsKey]  = data.slice(start, start + count);\r\n        results.final =  start + count >= data.length;\r\n        results.total = data.length;\r\n        callback(null, results);\r\n    }\r\n\r\n}\r\n"]}